<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Anime Details</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <style>
      /* Estilos adicionales para el enfoque visual */
      .highlight {
        background-color: rgba(0, 0, 255, 0.3); /* Color de fondo al enfocar */
        border: 2px solid blue; /* Borde azul para resaltar */
      }
    </style>
</head>
<body>
  <div class="anime-details">
    <div class="anime-container">
      <img id="portada" alt="Portada del Anime">
      <p id="descripcion" class="anime-description"></p>
    </div>
    <div class="anime-container">
      <h1 id="titulo" class="anime-title"></h1>
      <input type="number" id="filtro-capitulo" placeholder="Ir al cap칤tulo" min="1" autofocus>
      <ul id="capitulos" class="episodes-list"></ul>
    </div>
  </div>
  <footer>Desarrollado por Santiago Cardona 游떂</footer>
  <script>
    const id = new URLSearchParams(location.search).get("id");

    fetch(`https://backend-animeflv-lite.onrender.com/api/anime?id=${id}`)
      .then(res => res.json())
      .then(anime => {
        document.getElementById("titulo").textContent = anime.title;
        document.getElementById("portada").src = anime.cover;
        document.getElementById("descripcion").textContent = anime.synopsis;

        const capContenedor = document.getElementById("capitulos");
        const filtroCapitulo = document.getElementById("filtro-capitulo");

        // Establecer foco en el input al cargar la p치gina
        filtroCapitulo.focus();
        filtroCapitulo.classList.add("highlight");

        anime.episodes.forEach(ep => {
          const li = document.createElement("li");
          const btn = document.createElement("button");
          btn.className = "episode-btn";
          btn.textContent = `Episodio ${ep.number || ep.title || 'desconocido'}`;
          btn.dataset.numero = ep.number || 0;
          btn.onclick = () => {
            fetch(`https://backend-animeflv-lite.onrender.com/api/episode?url=${encodeURIComponent(ep.url)}`)
              .then(res => res.json())
              .then(data => {
                if (!data.servidores || !Array.isArray(data.servidores) || data.servidores.length === 0) {
                  alert('No se encontraron links de video.');
                  return;
                }
                const param = btoa(JSON.stringify(data.servidores));
                window.location.href = `ver.html?embeds=${param}`;
              })
              .catch(err => {
                alert('Error al obtener los links de video');
                console.error(err);
              });
          };
          li.appendChild(btn);
          capContenedor.appendChild(li);
        });

        // Agregar evento de navegaci칩n por n칰mero de cap칤tulo
        filtroCapitulo.addEventListener('change', () => {
          const numCapitulo = parseInt(filtroCapitulo.value);
          const botones = capContenedor.querySelectorAll('.episode-btn');
          const botonObjetivo = Array.from(botones).find(btn => parseInt(btn.dataset.numero) === numCapitulo);
          
          if (botonObjetivo) {
            botonObjetivo.scrollIntoView({ behavior: 'smooth', block: 'center' });
            botonObjetivo.classList.add('highlight');
            setTimeout(() => botonObjetivo.classList.remove('highlight'), 2000);
          } else {
            alert(`Cap칤tulo ${numCapitulo} no encontrado`);
          }
        });

        // Manejar navegaci칩n con teclas de flecha
        filtroCapitulo.addEventListener('keydown', (e) => {
          const botones = capContenedor.querySelectorAll('.episode-btn');
          const botonActual = document.querySelector('.episode-btn.highlight');
          const indiceActual = botonActual ? Array.from(botones).indexOf(botonActual) : -1;

          switch (e.key) {
            case 'ArrowDown':
              e.preventDefault();
              if (indiceActual < botones.length - 1) {
                if (botonActual) botonActual.classList.remove('highlight');
                const siguienteBoton = botones[indiceActual + 1];
                siguienteBoton.classList.add('highlight');
                siguienteBoton.scrollIntoView({ behavior: 'smooth', block: 'center' });
              }
              break;
            case 'ArrowUp':
              e.preventDefault();
              if (indiceActual > 0) {
                if (botonActual) botonActual.classList.remove('highlight');
                const anteriorBoton = botones[indiceActual - 1];
                anteriorBoton.classList.add('highlight');
                anteriorBoton.scrollIntoView({ behavior: 'smooth', block: 'center' });
              } else {
                // Si estamos en el primer bot칩n y presionamos 'ArrowUp', el foco va al input
                filtroCapitulo.focus();
                filtroCapitulo.classList.add('highlight');
              }
              break;
            case 'Enter':
              if (botonActual) {
                botonActual.click();
              }
              break;
          }
        });
      });
  </script>
</body>
</html>
